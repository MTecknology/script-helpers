#!/bin/bash
##
# Find and run test units on shell scripts
##

# Repository root
TEST_DIR="$(dirname "$0")"; export TEST_DIR

# Test shell
TEST_SHELL="${TEST_SHELL:-sh}"
printf 'Using shell: %s\n' "$TEST_SHELL"


main() {
	TESTS_FAILED='false'

	# Run tests
	run_tests 'Constant'
	run_tests 'Function'

	# Print summary
	if [ "$TESTS_FAILED" = 'true' ]; then
		printf '!!! One or more tests failed. !!!\n'
		return 1
	fi
	return 0
}


run_tests() {
	printf 'Running %s Tests...\n' "$1"

	for path in "$TEST_DIR/shell_units/$1/"*; do
		file="$(basename "$path")"
		# Skip files starting with an underscore
		[ "$file" = "${file#_}" ] || continue

		# Run test unit
		printf '%24s:\t' "$file"
		if ! ("$TEST_SHELL" "$path"); then
			printf 'FAILED\n'
			TESTS_FAILED='true'
		else
			printf 'Passed\n'
		fi
	done
}


main "$@"
